<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salamander WebTuber v2.3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            margin: 0; 
            overflow: hidden; 
            background-color: #111; 
            font-family: 'Segoe UI', sans-serif;
        }
        
        /* --- STAGE (The Scene) --- */
        #stage {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            overflow: hidden;
            background-color: #00b140; 
        }

        /* Interactive Elements Wrappers */
        .interactive-layer {
            position: absolute;
            transform-origin: center center;
            cursor: grab;
            user-select: none;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .interactive-layer:active { cursor: grabbing; }
        .interactive-layer.locked { cursor: default; pointer-events: none; }

        /* Background specific */
        #bg-wrapper {
            top: 50%; left: 50%;
            width: 100vw; height: 100vh;
            z-index: 0;
        }
        #bg-img {
            width: 100%; height: 100%;
            object-fit: cover;
            pointer-events: none;
        }

        /* Avatar specific */
        #avatar-wrapper {
            top: 50%; left: 50%;
            width: 400px; height: 400px;
            z-index: 10;
            transform: translate(-50%, -50%) scale(1); 
        }

        /* The Physics Container (Inside wrapper) */
        #avatar-physics {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            transform-origin: bottom center;
            pointer-events: none;
            transition: transform 0.1s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        #avatar-img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            pointer-events: none;
            transition: filter 0.1s;
        }

        /* Swear Symbols - Fixed Opacity */
        .swear-symbol {
            position: absolute;
            font-weight: 900;
            color: #ef4444; 
            text-shadow: 2px 2px 0px #000;
            font-family: 'Comic Sans MS', sans-serif;
            opacity: 1; /* Fixed visibility */
            pointer-events: none;
            z-index: 20;
        }
        /* Swear Layer controls visibility */
        #swear-layer {
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }

        /* --- UI CONTROLS --- */
        #controls {
            position: absolute;
            top: 10px; left: 10px;
            background: rgba(17, 24, 39, 0.95);
            padding: 20px;
            border-radius: 12px;
            color: white;
            width: 340px;
            max-height: 90vh;
            overflow-y: auto;
            z-index: 1000;
            backdrop-filter: blur(10px);
            border: 1px solid #374151;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        #controls.hidden {
            display: block !important;
            transform: translateX(-380px);
            opacity: 0;
            pointer-events: none;
        }

        #controls::-webkit-scrollbar { width: 6px; }
        #controls::-webkit-scrollbar-track { background: #1f2937; }
        #controls::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }

        .control-group { margin-bottom: 16px; border-bottom: 1px solid #374151; padding-bottom: 12px; }
        .control-group:last-child { border-bottom: none; }
        .control-group label { display: block; font-size: 11px; text-transform: uppercase; font-weight: 700; margin-bottom: 8px; color: #a5b4fc; letter-spacing: 0.05em; }
        
        input[type="range"] { width: 100%; accent-color: #a855f7; height: 4px; background: #4b5563; border-radius: 2px; }
        
        .file-btn {
            background: rgba(255,255,255,0.05); border: 1px dashed #6b7280;
            padding: 8px; border-radius: 6px; text-align: center; cursor: pointer; font-size: 12px; color: #d1d5db; transition: all 0.2s;
        }
        .file-btn:hover { border-color: #a855f7; background: rgba(168, 85, 247, 0.1); color: white; }

        .toggle-btn { @apply text-xs py-1 px-3 rounded border border-gray-600 bg-gray-800 text-gray-300 transition hover:bg-gray-700 cursor-pointer; }
        .toggle-btn.active { @apply bg-purple-600 border-purple-500 text-white; }

        #hint-overlay {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.7); color: #ccc; padding: 5px 15px; border-radius: 20px;
            font-size: 12px; pointer-events: none; opacity: 0; transition: opacity 0.5s; z-index: 500;
        }
        .show-hint #hint-overlay { opacity: 1; }

        /* Accordion style for Advanced settings */
        details summary { cursor: pointer; list-style: none; font-size: 12px; color: #9ca3af; outline: none; }
        details summary::-webkit-details-marker { display: none; }
        details summary:hover { color: #fff; }
        details[open] summary { margin-bottom: 10px; }
    </style>
</head>
<body class="show-hint">

    <!-- The Stage -->
    <div id="stage">
        
        <!-- Background Layer -->
        <div id="bg-wrapper" class="interactive-layer">
            <img id="bg-img" src="" style="display:none;">
        </div>

        <!-- Avatar Layer -->
        <div id="avatar-wrapper" class="interactive-layer">
            <div id="avatar-physics">
                <img id="avatar-img" src="https://cdn3.emoji.gg/emojis/8422-blobcat-coffee.png">
                <div id="swear-layer" class="absolute inset-0 pointer-events-none"></div>
            </div>
        </div>

    </div>

    <!-- Hint -->
    <div id="hint-overlay">Drag to Move â€¢ Wheel to Resize â€¢ 'H' to Hide UI</div>

    <!-- Controls -->
    <div id="controls">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-lg font-bold text-white">Web<span class="text-purple-400">Tuber</span> <span class="text-xs bg-purple-900 px-1 rounded">v2.3</span></h1>
            <button id="btn-hide" class="text-gray-400 hover:text-white text-sm" title="Press 'H' to toggle">Hide UI âœ•</button>
        </div>

        <div class="control-group">
            <button id="btn-start" class="w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-2 rounded-lg shadow-lg shadow-purple-900/30 transition flex items-center justify-center gap-2">
                <span>ðŸŽ¤</span> Start Mic
            </button>
        </div>

        <div class="control-group">
            <label>Scene Editor</label>
            <div class="flex gap-2 mb-2">
                <button id="btn-lock" class="toggle-btn w-full flex justify-center items-center gap-2">
                    <span>ðŸ”“</span> Unlocked
                </button>
                <button onclick="resetLayout()" class="toggle-btn w-auto" title="Reset Positions">â†º</button>
            </div>
            <p class="text-[10px] text-gray-500 leading-tight">
                â€¢ Unlock to Drag/Resize elements on screen.<br>
                â€¢ Press <b>'H'</b> to hide this menu for OBS.
            </p>
        </div>

        <div class="control-group">
            <label>Avatar Images</label>
            <div class="grid grid-cols-2 gap-2">
                <div class="file-btn" onclick="document.getElementById('input-idle').click()">
                    <span id="label-idle">ðŸ“‚ Idle Frames</span>
                </div>
                <div class="file-btn" onclick="document.getElementById('input-talk').click()">
                    <span id="label-talk">ðŸ“‚ Talk Frames</span>
                </div>
            </div>
            <input type="file" id="input-idle" class="hidden" multiple accept="image/*">
            <input type="file" id="input-talk" class="hidden" multiple accept="image/*">
        </div>

        <div class="control-group">
            <label>Settings</label>
            <div class="space-y-4">
                <div>
                    <div class="flex justify-between text-[10px] text-gray-400 mb-1">
                        <span>Mic Sensitivity</span>
                        <span id="vol-meter" class="text-green-400 font-mono">0</span>
                    </div>
                    <input type="range" id="slider-threshold" min="1" max="100" value="15">
                </div>
                
                <details>
                    <summary class="flex justify-between items-center bg-gray-800 p-2 rounded">
                        <span>ðŸ›  Advanced Animation</span>
                        <span class="text-[10px]">â–¼</span>
                    </summary>
                    <div class="pt-3 space-y-3 pl-1">
                        <div>
                            <div class="flex justify-between text-[10px] text-gray-400 mb-1">
                                <span>Idle Speed (Blink)</span>
                                <span id="speed-idle-val">150ms</span>
                            </div>
                            <input type="range" id="slider-speed-idle" min="50" max="1000" step="10" value="150" dir="rtl">
                        </div>
                        <div>
                            <div class="flex justify-between text-[10px] text-gray-400 mb-1">
                                <span>Talk Speed (Mouth)</span>
                                <span id="speed-talk-val">60ms</span>
                            </div>
                            <input type="range" id="slider-speed-talk" min="20" max="300" step="10" value="60" dir="rtl">
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-[10px] text-gray-400">Randomize Talk Frames</span>
                            <input type="checkbox" id="chk-random-talk" class="accent-purple-500" checked>
                        </div>
                        <div>
                            <div class="flex justify-between text-[10px] text-gray-400 mb-1">
                                <span>Bounce Physics</span>
                            </div>
                            <input type="range" id="slider-bounce" min="0" max="100" value="20">
                        </div>
                    </div>
                </details>
            </div>
        </div>

        <div class="control-group">
            <label>Shout Effects</label>
            <div class="flex gap-2">
                <button id="btn-toggle-swear" class="toggle-btn flex-1">ðŸ¤¬ Swear</button>
                <button id="btn-toggle-shake" class="toggle-btn flex-1 active">ðŸ«¨ Shake</button>
            </div>
            <div class="mt-2">
                <span class="text-[10px] text-gray-400 block mb-1">Zoom Amount</span>
                <input type="range" id="slider-zoom" min="100" max="150" value="110">
            </div>
        </div>

        <div class="control-group">
            <label>Background</label>
            <div class="flex items-center gap-2">
                <input type="color" id="bg-color-picker" value="#00b140" class="w-8 h-8 rounded cursor-pointer border-0 bg-transparent p-0">
                <div class="file-btn flex-1" onclick="document.getElementById('input-bg').click()">
                    <span id="label-bg">ðŸ–¼ Upload Image</span>
                </div>
            </div>
            <input type="file" id="input-bg" class="hidden" accept="image/*">
        </div>
    </div>

    <script>
        if (window.location.protocol === 'file:') alert("âš ï¸ Local File Detected. Mic access requires 'localhost' or GitHub Pages.");

        const state = {
            audioContext: null,
            analyser: null,
            dataArray: null,
            isTalking: false,
            isShouting: false,
            idleFrames: ["https://cdn3.emoji.gg/emojis/8422-blobcat-coffee.png"],
            talkFrames: ["https://cdn3.emoji.gg/emojis/9686-blobcat-hyper.gif"],
            currentFrameIndex: 0,
            lastFrameTime: 0,
            nextBlinkTime: 0,
            isBlinking: false,
            volume: 0,
            enableSwear: false,
            enableShake: true,
            randomTalk: true,
            isLocked: false
        };

        const els = {
            stage: document.getElementById('stage'),
            avatarWrapper: document.getElementById('avatar-wrapper'),
            avatarPhysics: document.getElementById('avatar-physics'),
            avatarImg: document.getElementById('avatar-img'),
            bgWrapper: document.getElementById('bg-wrapper'),
            bgImg: document.getElementById('bg-img'),
            swearLayer: document.getElementById('swear-layer'),
            controls: document.getElementById('controls'),
            volMeter: document.getElementById('vol-meter'),
            
            threshold: document.getElementById('slider-threshold'),
            bounce: document.getElementById('slider-bounce'),
            speedIdle: document.getElementById('slider-speed-idle'),
            speedTalk: document.getElementById('slider-speed-talk'),
            zoom: document.getElementById('slider-zoom'),
            bgColor: document.getElementById('bg-color-picker'),
            randomTalk: document.getElementById('chk-random-talk'),
            
            btnLock: document.getElementById('btn-lock')
        };

        // --- INTERACTION ---
        let dragTarget = null;
        let startX, startY, initialLeft, initialTop;

        function makeInteractive(el) {
            el.addEventListener('mousedown', (e) => {
                if (state.isLocked) return;
                if (e.button !== 0) return;
                e.preventDefault();
                dragTarget = el;
                startX = e.clientX;
                startY = e.clientY;
                initialLeft = el.offsetLeft;
                initialTop = el.offsetTop;
            });

            el.addEventListener('wheel', (e) => {
                if (state.isLocked) return;
                e.preventDefault();
                let currentScale = parseFloat(el.getAttribute('data-scale')) || 1;
                const delta = e.deltaY > 0 ? -0.05 : 0.05;
                let newScale = Math.max(0.1, currentScale + delta);
                el.setAttribute('data-scale', newScale);
                updateTransform(el);
            });
        }

        window.addEventListener('mousemove', (e) => {
            if (!dragTarget || state.isLocked) return;
            e.preventDefault();
            const dx = e.clientX - startX;
            const dy = e.clientY - startY;
            dragTarget.style.left = `${initialLeft + dx}px`;
            dragTarget.style.top = `${initialTop + dy}px`;
            dragTarget.setAttribute('data-dragged', 'true');
            updateTransform(dragTarget);
        });

        window.addEventListener('mouseup', () => { dragTarget = null; });

        function updateTransform(el) {
            const scale = parseFloat(el.getAttribute('data-scale')) || 1;
            const isDragged = el.getAttribute('data-dragged') === 'true';
            el.style.transform = isDragged ? `scale(${scale})` : `translate(-50%, -50%) scale(${scale})`;
        }

        makeInteractive(els.avatarWrapper);
        makeInteractive(els.bgWrapper);

        els.btnLock.addEventListener('click', () => {
            state.isLocked = !state.isLocked;
            if (state.isLocked) {
                els.btnLock.innerHTML = "<span>ðŸ”’</span> Locked";
                els.btnLock.classList.add('bg-red-900', 'border-red-700', 'text-red-200');
                els.avatarWrapper.classList.add('locked');
                els.bgWrapper.classList.add('locked');
            } else {
                els.btnLock.innerHTML = "<span>ðŸ”“</span> Unlocked";
                els.btnLock.className = "toggle-btn w-full flex justify-center items-center gap-2";
                els.avatarWrapper.classList.remove('locked');
                els.bgWrapper.classList.remove('locked');
            }
        });

        window.resetLayout = () => {
            if(confirm("Reset positions?")) {
                ['avatarWrapper', 'bgWrapper'].forEach(key => {
                    const el = els[key];
                    el.style.left = '50%';
                    el.style.top = '50%';
                    el.setAttribute('data-scale', 1);
                    el.setAttribute('data-dragged', 'false');
                    el.style.transform = `translate(-50%, -50%) scale(1)`;
                });
            }
        };

        // --- AUDIO ENGINE ---
        document.getElementById('btn-start').addEventListener('click', async () => {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                state.audioContext = new AudioContext();
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const microphone = state.audioContext.createMediaStreamSource(stream);
                state.analyser = state.audioContext.createAnalyser();
                state.analyser.fftSize = 512;
                microphone.connect(state.analyser);
                state.dataArray = new Uint8Array(state.analyser.frequencyBinCount);
                
                document.getElementById('btn-start').innerHTML = "<span>âœ…</span> Mic Active";
                document.getElementById('btn-start').classList.replace('bg-purple-600', 'bg-green-700');
                
                initSwearParticles();
                animate();
            } catch (err) { alert("Microphone denied."); }
        });

        function animate() {
            requestAnimationFrame(animate);
            if (state.analyser) {
                state.analyser.getByteFrequencyData(state.dataArray);
                let sum = 0;
                for(let i = 0; i < state.dataArray.length; i++) sum += state.dataArray[i];
                const average = sum / state.dataArray.length;
                state.volume = state.volume * 0.8 + average * 0.2;
                els.volMeter.innerText = Math.floor(state.volume);
            }

            const threshold = parseInt(els.threshold.value);
            const wasTalking = state.isTalking;
            state.isTalking = state.volume > threshold;
            state.isShouting = state.volume > (threshold * 2.5) || state.volume > 80;

            if (wasTalking !== state.isTalking) {
                state.currentFrameIndex = 0;
                state.lastFrameTime = 0;
                state.isBlinking = false;
            }

            // Animation Frame Logic
            const now = Date.now();
            
            if (state.isTalking) {
                // TALK Logic
                const speed = parseInt(els.speedTalk.value);
                if (now - state.lastFrameTime > speed) {
                    if (state.randomTalk && state.talkFrames.length > 1) {
                        // Random frame excluding current to force change
                        let nextFrame;
                        do {
                            nextFrame = Math.floor(Math.random() * state.talkFrames.length);
                        } while (nextFrame === state.currentFrameIndex && state.talkFrames.length > 1);
                        state.currentFrameIndex = nextFrame;
                    } else {
                        // Sequential loop
                        state.currentFrameIndex = (state.currentFrameIndex + 1) % state.talkFrames.length;
                    }
                    
                    if(state.talkFrames.length > 0) els.avatarImg.src = state.talkFrames[state.currentFrameIndex];
                    state.lastFrameTime = now;
                }
            } else {
                // IDLE Logic (Blinking)
                const speed = parseInt(els.speedIdle.value);
                
                if (!state.isBlinking && now > state.nextBlinkTime) {
                    state.isBlinking = true;
                    state.currentFrameIndex = 0; 
                }
                
                if (state.isBlinking && state.idleFrames.length > 1) {
                    if (now - state.lastFrameTime > speed) {
                        state.currentFrameIndex++;
                        if (state.currentFrameIndex >= state.idleFrames.length) {
                            state.currentFrameIndex = 0;
                            state.isBlinking = false;
                            state.nextBlinkTime = now + (Math.random() * 3000 + 2000);
                        }
                        els.avatarImg.src = state.idleFrames[state.currentFrameIndex];
                        state.lastFrameTime = now;
                    }
                } else if(state.idleFrames.length > 0 && els.avatarImg.src !== state.idleFrames[0]) {
                    els.avatarImg.src = state.idleFrames[0];
                }
            }

            // Physics
            let scaleX = 1, scaleY = 1, translateY = 0, rotate = 0;
            const bounceFactor = parseInt(els.bounce.value) / 3000;
            
            if (state.volume > 5) {
                const intensity = Math.max(0, state.volume - threshold); 
                const deformation = intensity * bounceFactor; 
                scaleY = 1 - (deformation * 0.2); 
                scaleX = 1 + (deformation * 0.1); 
                translateY = deformation * 10;
            }

            let zoomScale = 1;
            if (state.isShouting) {
                zoomScale = parseInt(els.zoom.value) / 100;
                if (state.enableShake) {
                    rotate = (Math.random() - 0.5) * 5;
                    translateY += (Math.random() - 0.5) * 10;
                }
                if (state.enableSwear) {
                    els.swearLayer.style.opacity = 1;
                    Array.from(els.swearLayer.children).forEach(c => {
                        c.style.transform = `translate(${Math.random()*10-5}px, ${Math.random()*10-5}px) rotate(${Math.random()*20-10}deg)`;
                    });
                } else els.swearLayer.style.opacity = 0;
            } else els.swearLayer.style.opacity = 0;

            els.stage.style.transform = `scale(${state.isShouting ? zoomScale : 1})`;
            els.avatarPhysics.style.transform = `translate(0px, ${translateY}px) scale(${scaleX}, ${scaleY}) rotate(${rotate}deg)`;
            els.avatarImg.style.filter = (state.isShouting && state.volume > 90) ? "brightness(1.2)" : "brightness(1.0)";
        }

        // --- FILE HANDLING ---
        function handleUpload(inputId, labelId, stateKey) {
            document.getElementById(inputId).addEventListener('change', function(e) {
                const files = Array.from(e.target.files);
                if (files.length > 0) {
                    files.sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: 'base' }));
                    const loadedFrames = [];
                    let count = 0;
                    files.forEach((file, i) => {
                        const reader = new FileReader();
                        reader.onload = (ev) => {
                            loadedFrames[i] = ev.target.result;
                            count++;
                            if (count === files.length) {
                                state[stateKey] = loadedFrames;
                                state.currentFrameIndex = 0;
                                document.getElementById(labelId).innerText = `âœ… ${files.length} Frames`;
                                document.getElementById(labelId).parentElement.classList.add('border-green-500', 'text-green-400');
                            }
                        };
                        reader.readAsDataURL(file);
                    });
                }
            });
        }

        handleUpload('input-idle', 'label-idle', 'idleFrames');
        handleUpload('input-talk', 'label-talk', 'talkFrames');

        document.getElementById('input-bg').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    els.bgImg.src = ev.target.result;
                    els.bgImg.style.display = 'block';
                    document.getElementById('label-bg').innerText = "âœ… Loaded";
                };
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('bg-color-picker').addEventListener('input', (e) => {
            els.stage.style.backgroundColor = e.target.value;
        });

        function initSwearParticles() {
            const symbols = ['@', '#', '!', '%', '&', '$', 'ðŸ¤¬', 'ðŸ’¢'];
            for(let i=0; i<10; i++) {
                const el = document.createElement('div');
                el.className = 'swear-symbol';
                el.innerText = symbols[Math.floor(Math.random() * symbols.length)];
                el.style.left = (20 + Math.random() * 60) + '%';
                el.style.top = (10 + Math.random() * 40) + '%';
                el.style.fontSize = (20 + Math.random() * 30) + 'px';
                el.style.transform = `rotate(${Math.random() * 60 - 30}deg)`;
                els.swearLayer.appendChild(el);
            }
        }

        // Toggles & UI
        const toggleUI = () => {
            els.controls.classList.toggle('hidden');
            document.body.classList.toggle('show-hint');
        };
        document.getElementById('btn-hide').addEventListener('click', toggleUI);
        window.addEventListener('keydown', (e) => { if (e.key.toLowerCase() === 'h') toggleUI(); });

        ['btn-toggle-swear', 'btn-toggle-shake'].forEach(id => {
            document.getElementById(id).addEventListener('click', function() {
                this.classList.toggle('active');
                if(id.includes('swear')) state.enableSwear = !state.enableSwear;
                if(id.includes('shake')) state.enableShake = !state.enableShake;
            });
        });

        els.randomTalk.addEventListener('change', (e) => state.randomTalk = e.target.checked);
        els.speedIdle.addEventListener('input', (e) => document.getElementById('speed-idle-val').innerText = e.target.value + 'ms');
        els.speedTalk.addEventListener('input', (e) => document.getElementById('speed-talk-val').innerText = e.target.value + 'ms');

    </script>
</body>
</html>
