<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twitch Giveaway Bot</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/comfy.js@latest/dist/comfy.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        /* Base styles */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* OBS Overlay specific: Transparent */
        body.mode-obs { background-color: rgba(0, 0, 0, 0); overflow: hidden; }
        
        /* Admin specific: Dark Theme */
        body.mode-admin { background-color: #111827; color: #e5e7eb; overflow-y: auto; }

        /* Animations */
        .fade-in { animation: fadeIn 0.5s ease-in forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Winner Card Styles */
        .winner-card {
            background: rgba(23, 23, 23, 0.95);
            border: 2px solid #a855f7;
            box-shadow: 0 0 30px rgba(168, 85, 247, 0.4);
        }

        /* Admin Table */
        .admin-table-row:nth-child(even) { background-color: rgba(255,255,255,0.05); }
    </style>
</head>
<body class="h-screen w-screen">

    <!-- ==================== ADMIN UI ==================== -->
    <div id="admin-app" class="hidden p-8 max-w-5xl mx-auto">
        
        <!-- Login / Lock Screen -->
        <div id="login-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-95 backdrop-blur-sm">
            <div class="bg-gray-800 p-8 rounded-xl border border-gray-700 shadow-2xl w-96 text-center">
                <h1 class="text-2xl font-bold text-white mb-2">游댏 Master Key</h1>
                <p class="text-gray-400 text-sm mb-6">Enter your session password to access settings.</p>
                <input type="password" id="master-key-input" placeholder="Enter Key..." class="w-full bg-gray-900 border border-gray-600 text-white rounded px-4 py-2 mb-4 focus:border-purple-500 outline-none transition">
                <button id="btn-login" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 rounded transition">Access Dashboard</button>
                <p id="login-error" class="text-red-500 text-xs mt-3 hidden">Incorrect key or corrupted data.</p>
            </div>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboard" class="hidden space-y-8">
            <!-- Header -->
            <div class="flex justify-between items-center border-b border-gray-700 pb-4">
                <div>
                    <h1 class="text-3xl font-bold text-white tracking-tight">Salamander<span class="text-purple-500">Bot</span> Admin</h1>
                    <p class="text-gray-400 text-sm mt-1">Status: <span id="admin-status" class="text-yellow-500 font-mono">Connecting...</span></p>
                </div>
                <div class="text-right">
                    <button id="btn-logout" class="text-xs text-gray-500 hover:text-white underline">Lock Session</button>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                
                <!-- Left Column: Settings -->
                <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 h-fit">
                    <h2 class="text-xl font-semibold mb-4 text-purple-400">丘뙖잺 Configuration</h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs text-gray-400 uppercase font-bold mb-1">Twitch Channel</label>
                            <input type="text" id="cfg-channel" class="w-full bg-gray-900 border border-gray-600 rounded px-3 py-2 text-sm focus:border-purple-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-400 uppercase font-bold mb-1">GitHub Repo (user/repo)</label>
                            <input type="text" id="cfg-repo" class="w-full bg-gray-900 border border-gray-600 rounded px-3 py-2 text-sm focus:border-purple-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-400 uppercase font-bold mb-1">GitHub Token (PAT)</label>
                            <input type="password" id="cfg-token" class="w-full bg-gray-900 border border-gray-600 rounded px-3 py-2 text-sm focus:border-purple-500 outline-none">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs text-gray-400 uppercase font-bold mb-1">Winners</label>
                                <input type="number" id="cfg-winners" value="2" min="1" max="100" class="w-full bg-gray-900 border border-gray-600 rounded px-3 py-2 text-sm focus:border-purple-500 outline-none">
                            </div>
                        </div>

                        <div class="pt-4 border-t border-gray-700">
                            <button id="btn-save" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded text-sm transition">Save & Connect</button>
                        </div>
                    </div>

                    <!-- OBS Link Generator -->
                    <div class="mt-8 pt-6 border-t border-gray-700">
                        <h3 class="text-sm font-bold text-gray-300 mb-2">OBS Overlay URL</h3>
                        <div class="relative group">
                            <input type="text" id="obs-url-output" readonly class="w-full bg-black border border-gray-600 text-gray-400 rounded px-3 py-2 text-xs font-mono truncate cursor-pointer" value="Configure to generate link...">
                            <button id="btn-copy" class="absolute right-1 top-1 bg-gray-700 hover:bg-gray-600 text-xs px-2 py-1 rounded">Copy</button>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">Paste this URL into a Browser Source in OBS. (Width: 1920, Height: 1080)</p>
                    </div>
                </div>

                <!-- Right Column: Participants -->
                <div class="lg:col-span-2 bg-gray-800 rounded-xl p-6 border border-gray-700 flex flex-col h-[600px]">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-purple-400">游논 Participants <span id="admin-count" class="bg-gray-700 text-white text-xs px-2 py-1 rounded-full ml-2">0</span></h2>
                        <div class="flex gap-2">
                             <button id="btn-clear" class="text-xs bg-red-900/50 hover:bg-red-900 text-red-200 px-3 py-1 rounded border border-red-800">Clear List</button>
                        </div>
                    </div>
                    
                    <div class="flex-1 overflow-y-auto bg-gray-900 rounded border border-gray-700">
                        <table class="w-full text-left text-sm text-gray-300">
                            <thead class="bg-gray-800 sticky top-0">
                                <tr>
                                    <th class="px-4 py-2 font-medium">Username</th>
                                    <th class="px-4 py-2 font-medium text-right">Time</th>
                                </tr>
                            </thead>
                            <tbody id="participant-list">
                                <!-- JS Injected Rows -->
                            </tbody>
                        </table>
                        <div id="empty-state" class="text-center text-gray-500 py-20 italic">
                            Waiting for '!sorsol치s' commands...
                        </div>
                    </div>
                    <div class="mt-4 text-xs text-gray-500 text-center">
                        To draw winners, a moderator must type <code>!gaclose</code> in Twitch Chat.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== OVERLAY UI ==================== -->
    <div id="overlay-app" class="hidden h-full w-full flex flex-col items-center justify-center">
        <!-- Overlay Status -->
        <div id="status-panel" class="absolute top-10 right-10 bg-black/50 px-4 py-2 rounded-lg border border-white/20 backdrop-blur-sm transition-all duration-300">
            <div class="flex items-center gap-2">
                <div id="status-dot" class="w-3 h-3 rounded-full bg-red-500 animate-pulse"></div>
                <span id="overlay-status-text" class="text-sm font-bold text-white uppercase tracking-wider">Loading...</span>
            </div>
            <div class="mt-1 text-xs text-gray-300 text-right">
                Entries: <span id="overlay-count" class="text-purple-400 font-mono text-lg">0</span>
            </div>
        </div>

        <!-- Winner Container -->
        <div id="winner-container" class="hidden flex flex-wrap justify-center gap-8 z-10 max-w-6xl">
            <!-- Winners injected here -->
        </div>

        <!-- Error Toast -->
        <div id="error-toast" class="hidden absolute bottom-10 bg-red-600 text-white px-6 py-3 rounded shadow-lg font-bold"></div>
    </div>

    <script type="module">
        import { Octokit } from "https://esm.sh/octokit";

        // ================= GLOBAL STATE =================
        const state = {
            mode: 'admin', // 'admin' or 'obs'
            participants: new Set(), // Using Set for uniqueness
            isOpen: false,
            config: {
                channel: '',
                repo: '',
                token: '',
                winners: 2
            },
            octokit: null
        };

        const els = {
            // Admin
            adminApp: document.getElementById('admin-app'),
            loginScreen: document.getElementById('login-screen'),
            dashboard: document.getElementById('dashboard'),
            loginError: document.getElementById('login-error'),
            masterKeyInput: document.getElementById('master-key-input'),
            
            // Config Inputs
            cfgChannel: document.getElementById('cfg-channel'),
            cfgRepo: document.getElementById('cfg-repo'),
            cfgToken: document.getElementById('cfg-token'),
            cfgWinners: document.getElementById('cfg-winners'),
            obsUrlOutput: document.getElementById('obs-url-output'),

            // Admin Lists
            participantList: document.getElementById('participant-list'),
            adminCount: document.getElementById('admin-count'),
            emptyState: document.getElementById('empty-state'),
            adminStatus: document.getElementById('admin-status'),

            // Overlay
            overlayApp: document.getElementById('overlay-app'),
            statusDot: document.getElementById('status-dot'),
            overlayStatusText: document.getElementById('overlay-status-text'),
            overlayCount: document.getElementById('overlay-count'),
            winnerContainer: document.getElementById('winner-container'),
            errorToast: document.getElementById('error-toast')
        };

        // ================= INIT LOGIC =================
        function init() {
            const params = new URLSearchParams(window.location.search);
            const payload = params.get('payload');

            if (payload) {
                // --- OBS OVERLAY MODE ---
                state.mode = 'obs';
                document.body.classList.add('mode-obs');
                els.overlayApp.classList.remove('hidden');
                
                try {
                    // Decode Config
                    const decoded = JSON.parse(atob(payload));
                    state.config = { ...state.config, ...decoded };
                    initComfy();
                    if(state.config.token) initOctokit();
                } catch (e) {
                    showError("Invalid Config Payload");
                }
            } else {
                // --- ADMIN MODE ---
                state.mode = 'admin';
                document.body.classList.add('mode-admin');
                els.adminApp.classList.remove('hidden');
                checkLogin();
            }
        }

        // ================= ADMIN FUNCTIONS =================
        
        // Simple XOR Cipher for local obfuscation (Not military grade, but stops casual glancing)
        const cipher = (text, key) => {
            if(!key) return text;
            return text.split('').map((c, i) => String.fromCharCode(c.charCodeAt(0) ^ key.charCodeAt(i % key.length))).join('');
        };

        function checkLogin() {
            const stored = localStorage.getItem('giveaway_config');
            if (!stored) {
                // New user
                return; 
            }
            // If returning user, logic is handled by button click
        }

        document.getElementById('btn-login').addEventListener('click', () => {
            const key = els.masterKeyInput.value;
            if (!key) return;

            const stored = localStorage.getItem('giveaway_config');
            
            if (stored) {
                // Try decrypt
                try {
                    const decrypted = JSON.parse(cipher(stored, key));
                    if (decrypted.check === 'ok') {
                        // Success
                        loadAdminDashboard(decrypted.data);
                    } else {
                        throw new Error('Bad key');
                    }
                } catch (e) {
                    els.loginError.classList.remove('hidden');
                    els.masterKeyInput.classList.add('border-red-500');
                }
            } else {
                // First time setup - treat this key as the new master key
                // Save an empty config to verify key later
                const dummy = { check: 'ok', data: { channel: '', repo: '', token: '', winners: 2 } };
                localStorage.setItem('giveaway_config', cipher(JSON.stringify(dummy), key));
                loadAdminDashboard(dummy.data);
            }
        });

        function loadAdminDashboard(data) {
            state.config = data;
            
            // Populate Inputs
            els.cfgChannel.value = data.channel || '';
            els.cfgRepo.value = data.repo || '';
            els.cfgToken.value = data.token || '';
            els.cfgWinners.value = data.winners || 2;

            els.loginScreen.classList.add('hidden');
            els.dashboard.classList.remove('hidden');

            updateObsUrl();

            // Auto connect if channel exists
            if (data.channel) {
                initComfy();
            }
        }

        document.getElementById('btn-save').addEventListener('click', () => {
            const key = els.masterKeyInput.value;
            const newConfig = {
                channel: els.cfgChannel.value,
                repo: els.cfgRepo.value,
                token: els.cfgToken.value,
                winners: parseInt(els.cfgWinners.value)
            };

            // Save to LocalStorage
            const envelope = { check: 'ok', data: newConfig };
            localStorage.setItem('giveaway_config', cipher(JSON.stringify(envelope), key));

            state.config = newConfig;
            updateObsUrl();
            
            // Re-init connections
            if(state.config.channel) initComfy();
            
            // Feedback
            const btn = document.getElementById('btn-save');
            const originalText = btn.innerText;
            btn.innerText = "Saved!";
            btn.classList.add('bg-green-500');
            setTimeout(() => { btn.innerText = originalText; btn.classList.remove('bg-green-500'); }, 1000);
        });

        document.getElementById('btn-copy').addEventListener('click', () => {
            const copyText = els.obsUrlOutput;
            copyText.select();
            document.execCommand("copy");
            alert("URL copied! Paste into OBS Browser Source.");
        });
        
        document.getElementById('btn-clear').addEventListener('click', () => {
            if(confirm("Clear all participants?")) {
                state.participants.clear();
                updateUI();
            }
        });

        document.getElementById('btn-logout').addEventListener('click', () => {
             location.reload();
        });

        function updateObsUrl() {
            // Create clean config for OBS (remove sensitive if needed, but we need token for upload)
            const obsPayload = JSON.stringify(state.config);
            const base64Payload = btoa(obsPayload);
            const url = `${window.location.protocol}//${window.location.host}${window.location.pathname}?payload=${base64Payload}`;
            els.obsUrlOutput.value = url;
        }


        // ================= SHARED LOGIC (COMFY + GITHUB) =================

        function initComfy() {
            if(!state.config.channel) return;

            // Disconnect if already connected (simple reload approach is safer but we'll try/catch)
            try { ComfyJS.Disconnect(); } catch(e){}

            ComfyJS.onCommand = handleCommand;
            ComfyJS.onConnected = () => {
                state.isOpen = true;
                if(state.mode === 'admin') {
                    els.adminStatus.innerText = "Connected to " + state.config.channel;
                    els.adminStatus.classList.remove('text-yellow-500', 'text-red-500');
                    els.adminStatus.classList.add('text-green-500');
                } else {
                    els.statusDot.className = "w-3 h-3 rounded-full bg-green-500";
                    els.overlayStatusText.innerText = "Ready";
                    console.log("OBS Connected");
                }
            };
            ComfyJS.onConnectionError = () => {
                if(state.mode === 'admin') els.adminStatus.innerText = "Error Connecting";
            };

            ComfyJS.Init(state.config.channel);
        }

        function initOctokit() {
            if(!state.config.token) return;
            try {
                state.octokit = new Octokit({ auth: state.config.token });
            } catch(e) { console.error("Octokit init failed", e); }
        }

        function handleCommand(user, command, message, flags, extra) {
            const cmd = command.toLowerCase();

            // !sorsol치s - JOIN
            if (cmd === 'sorsol치s' && state.isOpen) {
                if (!state.participants.has(user)) {
                    state.participants.add(user);
                    updateUI(user); // Pass user to animate or add row
                }
            }

            // !gaclose - CLOSE & DRAW (Mod Only)
            if (cmd === 'gaclose' && (flags.broadcaster || flags.mod)) {
                runDraw();
            }
        }

        function updateUI(newUser) {
            // Admin UI Update
            if (state.mode === 'admin') {
                els.adminCount.innerText = state.participants.size;
                if (state.participants.size > 0) els.emptyState.classList.add('hidden');
                
                if (newUser) {
                    const row = document.createElement('tr');
                    row.className = "admin-table-row border-b border-gray-700 hover:bg-white/5 transition";
                    row.innerHTML = `
                        <td class="px-4 py-2 font-mono text-purple-300">${newUser}</td>
                        <td class="px-4 py-2 text-right text-xs text-gray-500">${new Date().toLocaleTimeString()}</td>
                    `;
                    els.participantList.prepend(row);
                } else {
                    // Full refresh (e.g. clear)
                    els.participantList.innerHTML = '';
                    if(state.participants.size === 0) els.emptyState.classList.remove('hidden');
                }
            }
            
            // Overlay UI Update
            if (state.mode === 'obs') {
                els.overlayCount.innerText = state.participants.size;
                if (newUser) {
                    // Animation
                    els.overlayCount.classList.add('scale-150', 'text-green-400');
                    setTimeout(() => els.overlayCount.classList.remove('scale-150', 'text-green-400'), 200);
                }
            }
        }

        async function runDraw() {
            if (!state.isOpen) return;
            state.isOpen = false;

            // Stop accepting entries visually
            if (state.mode === 'obs') {
                els.statusDot.className = "w-3 h-3 rounded-full bg-yellow-500";
                els.overlayStatusText.innerText = "Drawing...";
            } else {
                els.adminStatus.innerText = "Drawing Winners...";
            }

            const userList = Array.from(state.participants);
            const winnerCount = state.config.winners || 2;

            if (userList.length < winnerCount) {
                if(state.mode === 'obs') showError(`Need ${winnerCount}+ entries`);
                else alert(`Not enough entries! Need ${winnerCount}+`);
                return;
            }

            // Pick Winners
            const winners = [];
            while (winners.length < winnerCount) {
                const randomIndex = Math.floor(Math.random() * userList.length);
                const winner = userList[randomIndex];
                if (!winners.includes(winner)) {
                    winners.push(winner);
                }
            }

            // Visuals (Only in OBS mode usually, but we can log in Admin)
            if (state.mode === 'obs') {
                els.winnerContainer.innerHTML = '';
                els.winnerContainer.classList.remove('hidden');
                for (const winner of winners) {
                    await renderWinnerCard(winner);
                }
                launchConfetti();
                
                // Upload Result
                if (state.octokit && state.config.repo) {
                    await uploadToGitHub(userList, winners);
                }
            } else {
                // Admin Mode Feedback
                alert(`Winners: ${winners.join(', ')}`);
            }
        }

        // ================= VISUALS & API =================

        async function renderWinnerCard(username) {
            let avatarUrl = "https://static-cdn.jtvnw.net/user-default-pictures-uv/cdd517fe-def4-11e9-948e-784f43822e80-profile_image-300x300.png";
            try {
                const response = await fetch(`https://decapi.me/twitch/avatar/${username}`);
                const text = await response.text();
                if (text && text.startsWith('http')) avatarUrl = text;
            } catch (e) { console.error("Avatar fetch failed", e); }

            const card = document.createElement('div');
            card.className = "winner-card p-6 rounded-xl flex flex-col items-center w-64 fade-in transform hover:scale-105 transition duration-500";
            card.innerHTML = `
                <div class="relative">
                    <img src="${avatarUrl}" class="w-24 h-24 rounded-full border-4 border-purple-500 mb-4 object-cover shadow-lg">
                    <div class="absolute -bottom-2 -right-2 bg-yellow-400 text-black font-bold px-2 py-1 rounded text-xs shadow-md animate-bounce">WINNER</div>
                </div>
                <h2 class="text-2xl font-bold text-white mb-1 truncate w-full text-center">${username}</h2>
                <p class="text-purple-300 text-sm">Congratulations!</p>
            `;
            els.winnerContainer.appendChild(card);
        }

        function launchConfetti() {
            const duration = 5000;
            const end = Date.now() + duration;
            (function frame() {
                confetti({ particleCount: 5, angle: 60, spread: 55, origin: { x: 0 }, colors: ['#a855f7', '#ffffff', '#fbbf24'] });
                confetti({ particleCount: 5, angle: 120, spread: 55, origin: { x: 1 }, colors: ['#a855f7', '#ffffff', '#fbbf24'] });
                if (Date.now() < end) requestAnimationFrame(frame);
            }());
        }

        async function uploadToGitHub(allParticipants, winners) {
            try {
                els.overlayStatusText.innerText = "Saving...";
                const date = new Date().toISOString().replace(/[:.]/g, '-');
                const [owner, repoName] = state.config.repo.split('/');
                
                if (!owner || !repoName) throw new Error("Invalid Repo");

                const contentString = `WINNERS:\n${winners.join('\n')}\n\nALL PARTICIPANTS (${allParticipants.length}):\n${allParticipants.join('\n')}`;
                const contentBase64 = btoa(unescape(encodeURIComponent(contentString)));

                await state.octokit.request('PUT /repos/{owner}/{repo}/contents/{path}', {
                    owner: owner,
                    repo: repoName,
                    path: `giveaways/giveaway-${date}.txt`,
                    message: `Giveaway results: ${date}`,
                    committer: { name: "Giveaway Bot", email: "bot@localhost" },
                    content: contentBase64
                });

                els.overlayStatusText.innerText = "Saved";
                els.statusDot.className = "w-3 h-3 rounded-full bg-blue-500";
            } catch (err) {
                console.error("GitHub Upload Error:", err);
                showError("Save Failed");
            }
        }

        function showError(msg) {
            els.errorToast.innerText = msg;
            els.errorToast.classList.remove('hidden');
            setTimeout(() => els.errorToast.classList.add('hidden'), 5000);
        }

        // Start
        init();
    </script>
</body>
</html>