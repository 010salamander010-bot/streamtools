<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hogwarts House Points 0.8 (Visual Fixes)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- ComfyJS Library (Wrapper for TMI.js) -->
    <script src="https://cdn.jsdelivr.net/npm/comfy.js@latest/dist/comfy.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap');

        body {
            font-family: 'Cinzel', serif;
            background-color: #0f0f13;
            background-image: radial-gradient(circle at 50% 50%, #1a1a24 0%, #0a0a0c 100%);
            color: #e2e8f0;
            overflow: hidden;
        }

        /* Glass Shine Effect */
        .glass-shine {
            background: linear-gradient(120deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.15) 40%, rgba(255,255,255,0) 100%);
            pointer-events: none;
        }

        /* Text Shadows for readability */
        .text-glow {
            text-shadow: 0 0 10px currentColor;
        }

        /* House Specific Colors for Text/Glow */
        .gryffindor-color { color: #ff4d4d; }
        .slytherin-color { color: #2ecc71; }
        .ravenclaw-color { color: #3498db; }
        .hufflepuff-color { color: #f1c40f; }
        
        /* Custom Input Styling */
        .magic-input {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #4a5568;
            color: #e2e8f0;
            transition: all 0.3s ease;
        }
        .magic-input:focus {
            border-color: #f6ad55;
            box-shadow: 0 0 10px rgba(246, 173, 85, 0.3);
            outline: none;
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: 10; /* Behind the house containers which are z-20 */
        }

        /* Test Button Styling (Visible on Hover) */
        .house-container:hover .test-btn {
            opacity: 1;
            transform: translateY(0);
        }
        .test-btn {
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
        }

        /* Hourglass Container Styling */
        .hourglass-wrapper {
            position: relative;
            width: 100%;
            max-width: 120px;
            height: 60vh;
            /* Create a mask for the canvas behind it */
            /* We use the SVG shape to "cut out" the background so we can see particles only here? 
               Actually, simpler: Canvas is Z-10. Hourglass SVG is Z-20. 
               The SVG has a transparent "window" area. 
               The particles fall behind. 
               We just need to align them perfectly. */
        }
    </style>
</head>
<body class="h-screen w-full flex flex-col items-center justify-between py-6">

    <!-- Header / Controls -->
    <div class="z-50 w-full max-w-4xl px-4 flex flex-col md:flex-row items-center justify-between gap-4 mb-4">
        <h1 class="text-3xl font-bold tracking-widest text-amber-500 text-center md:text-left drop-shadow-lg">HOUSE POINTS</h1>
        
        <div class="flex gap-2 relative">
            <input type="text" id="channelInput" placeholder="Twitch Channel Name" class="magic-input px-4 py-2 rounded font-sans text-sm w-48">
            <button onclick="connectToTwitch()" id="connectBtn" class="bg-amber-700 hover:bg-amber-600 text-white font-bold py-2 px-6 rounded transition-colors text-sm font-sans border border-amber-800">
                CONNECT
            </button>
        </div>
        
        <div id="status" class="text-xs text-gray-500 font-sans italic">Status: Disconnected</div>
    </div>

    <!-- Main Hourglass Display -->
    <div class="flex-grow w-full max-w-6xl grid grid-cols-4 gap-4 px-4 items-end justify-items-center relative">
        
        <!-- Canvas for particle effects sits BEHIND the hourglasses (z-10 vs z-20) -->
        <canvas id="particleCanvas"></canvas>

        <!-- Gryffindor / Griffendél -->
        <div class="flex flex-col items-center w-full h-full justify-end relative z-20 house-container group" data-house="gryffindor">
            <button onclick="manualAdd('gryffindor')" class="test-btn mb-4 px-3 py-1 bg-gray-800 text-xs rounded border border-gray-600 hover:bg-gray-700 font-sans text-gray-400">Test +10</button>
            <div class="text-4xl font-bold mb-2 gryffindor-color score-display drop-shadow-md">0</div>
            <div class="hourglass-wrapper">
                <svg viewBox="0 0 100 300" class="w-full h-full drop-shadow-2xl filter" style="filter: drop-shadow(0 0 15px rgba(255, 0, 0, 0.3));">
                    <defs>
                        <clipPath id="clip-gryffindor">
                            <path d="M10,0 L90,0 Q100,50 50,150 Q0,250 10,300 L90,300 Q100,250 50,150 Q0,50 10,0 Z" />
                        </clipPath>
                    </defs>
                    
                    <!-- Background Glass (Transparent fill so we see particles behind, stroke for frame) -->
                    <path d="M10,0 L90,0 Q100,50 50,150 Q0,250 10,300 L90,300 Q100,250 50,150 Q0,50 10,0 Z" 
                          fill="rgba(0,0,0,0.3)" stroke="#4a1a1a" stroke-width="4"/>

                    <!-- The Sand Pile (Fill Level) - Drawn ON TOP of particles but clipped to bottom -->
                    <!-- We want particles to fall 'behind' this pile if they are 'in' it, or just merge. -->
                    <rect x="0" y="0" width="100" height="300" fill="#740001" 
                          class="transition-all duration-1000 ease-out fill-rect"
                          style="clip-path: url(#clip-gryffindor); transform-origin: bottom; transform: scaleY(0);" />
                    
                    <!-- Shine overlay (Topmost) -->
                    <path d="M10,0 L90,0 Q100,50 50,150 Q0,250 10,300 L90,300 Q100,250 50,150 Q0,50 10,0 Z" 
                          fill="url(#glassShine)" class="opacity-40 pointer-events-none"/>
                </svg>
            </div>
            <h2 class="mt-4 text-xl tracking-widest text-gray-400 uppercase text-center text-sm md:text-xl font-bold">Griffendél</h2>
        </div>

        <!-- Slytherin / Mardekár -->
        <div class="flex flex-col items-center w-full h-full justify-end relative z-20 house-container group" data-house="slytherin">
            <button onclick="manualAdd('slytherin')" class="test-btn mb-4 px-3 py-1 bg-gray-800 text-xs rounded border border-gray-600 hover:bg-gray-700 font-sans text-gray-400">Test +10</button>
            <div class="text-4xl font-bold mb-2 slytherin-color score-display drop-shadow-md">0</div>
            <div class="hourglass-wrapper">
                <svg viewBox="0 0 100 300" class="w-full h-full drop-shadow-2xl" style="filter: drop-shadow(0 0 15px rgba(0, 255, 0, 0.3));">
                    <defs>
                        <clipPath id="clip-slytherin">
                            <path d="M10,0 L90,0 Q100,50 50,150 Q0,250 10,300 L90,300 Q100,250 50,150 Q0,50 10,0 Z" />
                        </clipPath>
                    </defs>
                    <path d="M10,0 L90,0 Q100,50 50,150 Q0,250 10,300 L90,300 Q100,250 50,150 Q0,50 10,0 Z" 
                          fill="rgba(0,0,0,0.3)" stroke="#1a472a" stroke-width="4"/>
                    <rect x="0" y="0" width="100" height="300" fill="#1a472a" 
                          class="transition-all duration-1000 ease-out fill-rect"
                          style="clip-path: url(#clip-slytherin); transform-origin: bottom; transform: scaleY(0);" />
                    <path d="M10,0 L90,0 Q100,50 50,150 Q0,250 10,300 L90,300 Q100,250 50,150 Q0,50 10,0 Z" 
                          fill="url(#glassShine)" class="opacity-40 pointer-events-none"/>
                </svg>
            </div>
            <h2 class="mt-4 text-xl tracking-widest text-gray-400 uppercase text-center text-sm md:text-xl font-bold">Mardekár</h2>
        </div>

        <!-- Ravenclaw / Hollóhát -->
        <div class="flex flex-col items-center w-full h-full justify-end relative z-20 house-container group" data-house="ravenclaw">
            <button onclick="manualAdd('ravenclaw')" class="test-btn mb-4 px-3 py-1 bg-gray-800 text-xs rounded border border-gray-600 hover:bg-gray-700 font-sans text-gray-400">Test +10</button>
            <div class="text-4xl font-bold mb-2 ravenclaw-color score-display drop-shadow-md">0</div>
            <div class="hourglass-wrapper">
                <svg viewBox="0 0 100 300" class="w-full h-full drop-shadow-2xl" style="filter: drop-shadow(0 0 15px rgba(0, 0, 255, 0.3));">
                    <defs>
                        <clipPath id="clip-ravenclaw">
                            <path d="M10,0 L90,0 Q100,50 50,150 Q0,250 10,300 L90,300 Q100,250 50,150 Q0,50 10,0 Z" />
                        </clipPath>
                    </defs>
                    <path d="M10,0 L90,0 Q100,50 50,150 Q0,250 10,300 L90,300 Q100,250 50,150 Q0,50 10,0 Z" 
                          fill="rgba(0,0,0,0.3)" stroke="#0e1a40" stroke-width="4"/>
                    <rect x="0" y="0" width="100" height="300" fill="#222f5b" 
                          class="transition-all duration-1000 ease-out fill-rect"
                          style="clip-path: url(#clip-ravenclaw); transform-origin: bottom; transform: scaleY(0);" />
                    <path d="M10,0 L90,0 Q100,50 50,150 Q0,250 10,300 L90,300 Q100,250 50,150 Q0,50 10,0 Z" 
                          fill="url(#glassShine)" class="opacity-40 pointer-events-none"/>
                </svg>
            </div>
            <h2 class="mt-4 text-xl tracking-widest text-gray-400 uppercase text-center text-sm md:text-xl font-bold">Hollóhát</h2>
        </div>

        <!-- Hufflepuff / Hugrabug -->
        <div class="flex flex-col items-center w-full h-full justify-end relative z-20 house-container group" data-house="hufflepuff">
            <button onclick="manualAdd('hufflepuff')" class="test-btn mb-4 px-3 py-1 bg-gray-800 text-xs rounded border border-gray-600 hover:bg-gray-700 font-sans text-gray-400">Test +10</button>
            <div class="text-4xl font-bold mb-2 hufflepuff-color score-display drop-shadow-md">0</div>
            <div class="hourglass-wrapper">
                <svg viewBox="0 0 100 300" class="w-full h-full drop-shadow-2xl" style="filter: drop-shadow(0 0 15px rgba(255, 255, 0, 0.3));">
                    <defs>
                        <clipPath id="clip-hufflepuff">
                            <path d="M10,0 L90,0 Q100,50 50,150 Q0,250 10,300 L90,300 Q100,250 50,150 Q0,50 10,0 Z" />
                        </clipPath>
                    </defs>
                    <path d="M10,0 L90,0 Q100,50 50,150 Q0,250 10,300 L90,300 Q100,250 50,150 Q0,50 10,0 Z" 
                          fill="rgba(0,0,0,0.3)" stroke="#ecb939" stroke-width="4"/>
                    <rect x="0" y="0" width="100" height="300" fill="#ecb939" 
                          class="transition-all duration-1000 ease-out fill-rect"
                          style="clip-path: url(#clip-hufflepuff); transform-origin: bottom; transform: scaleY(0);" />
                    <path d="M10,0 L90,0 Q100,50 50,150 Q0,250 10,300 L90,300 Q100,250 50,150 Q0,50 10,0 Z" 
                          fill="url(#glassShine)" class="opacity-40 pointer-events-none"/>
                </svg>
            </div>
            <h2 class="mt-4 text-xl tracking-widest text-gray-400 uppercase text-center text-sm md:text-xl font-bold">Hugrabug</h2>
        </div>
    </div>

    <!-- Global SVG Defs -->
    <svg width="0" height="0">
        <defs>
            <linearGradient id="glassShine" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" style="stop-color:rgb(255,255,255);stop-opacity:0" />
                <stop offset="50%" style="stop-color:rgb(255,255,255);stop-opacity:0.25" />
                <stop offset="100%" style="stop-color:rgb(255,255,255);stop-opacity:0" />
            </linearGradient>
        </defs>
    </svg>

    <!-- Recent Events Log (Optional, visible just to confirm logic) -->
    <div id="log" class="text-[10px] text-gray-700 font-sans fixed bottom-2 right-2 opacity-50">Waiting for events...</div>

    <script>
        // --- CONFIG & STATE ---
        const HOUSE_CONFIG = {
            gryffindor: { color: '#740001', maxPoints: 500, current: 0 },
            slytherin:  { color: '#1a472a', maxPoints: 500, current: 0 },
            ravenclaw:  { color: '#222f5b', maxPoints: 500, current: 0 },
            hufflepuff: { color: '#ecb939', maxPoints: 500, current: 0 }
        };
        
        // Mapping Hungarian/Alt names to main keys
        const HOUSE_MAPPING = {
            'gryffindor': 'gryffindor',
            'griffendél': 'gryffindor',
            'slytherin': 'slytherin',
            'mardekár': 'slytherin',
            'ravenclaw': 'ravenclaw',
            'hollóhát': 'ravenclaw',
            'hufflepuff': 'hufflepuff',
            'hugrabug': 'hufflepuff'
        };

        // --- TWITCH CONNECTION ---
        function connectToTwitch() {
            let channelInput = document.getElementById('channelInput').value.trim();
            const statusEl = document.getElementById('status');
            const btn = document.getElementById('connectBtn');

            if (!channelInput) {
                alert("Please enter a channel name!");
                return;
            }
            
            // --- CLEAN INPUT ---
            let channel = channelInput.replace("https://", "")
                                     .replace("http://", "")
                                     .replace("www.", "")
                                     .replace("twitch.tv/", "")
                                     .replace("@", "")
                                     .replace("#", "");

            // Split by slash to drop subpaths (e.g. /videos) and handle spaces
            channel = channel.split('/')[0].toLowerCase().trim();

            if (!channel) {
                alert("Invalid channel name!");
                return;
            }

            console.log("Connecting to channel:", channel);

            // Disconnect previous instance if exists
            try { ComfyJS.Disconnect(); } catch(e) {}

            statusEl.textContent = `Connecting to ${channel}...`;
            statusEl.className = "text-xs text-yellow-500 font-sans italic";
            btn.disabled = true;

            // --- COMFYJS EVENT HANDLERS ---
            
            ComfyJS.onChat = (user, message, flags, self, extra) => {
                // Pass to existing parser logic
                parseMessage(message, user);
            };

            ComfyJS.onConnected = (address, port, isFirstConnect) => {
                statusEl.textContent = `Connected to ${channel}`;
                statusEl.className = "text-xs text-green-500 font-sans italic";
                btn.textContent = "CONNECTED";
                btn.classList.replace('bg-amber-700', 'bg-green-800');
                btn.classList.replace('hover:bg-amber-600', 'hover:bg-green-700');
                btn.disabled = false;
                document.getElementById('log').textContent = "Listening for points...";
            };
            
            ComfyJS.onError = (error) => {
                console.error("ComfyJS Error:", error);
                statusEl.textContent = `Error: ${error}`;
                statusEl.className = "text-xs text-red-500 font-sans italic";
                btn.disabled = false;
            };

            // Init Connection
            ComfyJS.Init(channel);
        }

        // --- MESSAGE PARSING ---
        function parseMessage(msg, username) {
            // Regex to support English & Hungarian
            // Group 1: Number
            // Non-capturing: space + points OR pont(with optional suffix chars)
            // Non-capturing: space + to/for/a (optional)
            // Group 2: House Name (including Hungarian variants)
            const regex = /(-?\d+)\s+(?:points?|pont[a-z]*)\s+(?:to|for|a)?\s*(gryffindor|slytherin|ravenclaw|hufflepuff|griffendél|mardekár|hollóhát|hugrabug)/i;
            
            const match = msg.match(regex);

            if (match) {
                const points = parseInt(match[1]);
                const rawHouse = match[2].toLowerCase();
                const houseKey = HOUSE_MAPPING[rawHouse];
                
                if (!isNaN(points) && houseKey && HOUSE_CONFIG[houseKey]) {
                    updatePoints(houseKey, points);
                    logEvent(`${username}: ${points} -> ${houseKey} (${rawHouse})`);
                    
                    if (points > 0) {
                        triggerParticles(houseKey, points);
                    }
                }
            }
        }

        // --- MANUAL TEST FUNCTION ---
        function manualAdd(house) {
            updatePoints(house, 10);
            triggerParticles(house, 10);
            logEvent(`Test: 10 points to ${house}`);
        }

        function updatePoints(house, points) {
            const config = HOUSE_CONFIG[house];
            config.current += points;
            
            // Prevent negative total points (optional rule)
            if (config.current < 0) config.current = 0;

            // DOM Updates
            const container = document.querySelector(`.house-container[data-house="${house}"]`);
            const scoreEl = container.querySelector('.score-display');
            const fillRect = container.querySelector('.fill-rect');

            // Update Number
            scoreEl.textContent = config.current;

            // Update Visual Fill (Cap at 100% for visual purposes, but keep counting real score)
            // We scale based on maxPoints (e.g., 500 points = full glass)
            let percentage = (config.current / config.maxPoints);
            if (percentage > 1) percentage = 1; 
            if (percentage < 0) percentage = 0;
            
            fillRect.style.transform = `scaleY(${percentage})`;
        }

        function logEvent(text) {
            const log = document.getElementById('log');
            log.textContent = text;
            log.style.opacity = 1;
            setTimeout(() => log.style.opacity = 0.5, 2000);
        }

        // --- PARTICLE SYSTEM (THE GEMS) ---
        const canvas = document.getElementById('particleCanvas');
        const ctx = canvas.getContext('2d');
        let particles = [];

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        // Initial resize handled on load implicitly or here
        resizeCanvas();

        class Particle {
            constructor(house) {
                // Find the house container position
                const container = document.querySelector(`.house-container[data-house="${house}"]`);
                // Important: Look for the specific hourglass SVG wrapper
                const wrapper = container.querySelector('.hourglass-wrapper');
                const rect = wrapper.getBoundingClientRect();
                
                // Spawn within the glass bulb width (approx 80px wide at top?)
                // The SVG viewbox is 100 wide. Top bulb is roughly 10-90.
                // We map this relative to the rendered width.
                const spawnWidth = rect.width * 0.6; // slightly narrower than full width
                const centerX = rect.left + rect.width / 2;
                
                this.x = centerX + (Math.random() * spawnWidth - spawnWidth/2);
                this.y = rect.top + 20; // Start inside the top bulb
                
                // Physics
                this.vx = (Math.random() - 0.5) * 1; // Less horizontal jitter
                this.vy = Math.random() * 2 + 2; // Initial downward velocity
                this.gravity = 0.2;
                
                // Appearance
                this.size = Math.random() * 3 + 2;
                this.color = HOUSE_CONFIG[house].color;
                this.life = 100; // Frames to live
                
                // Floor logic - roughly bottom of the visible glass
                this.floor = rect.bottom - 20; 
                
                // Clip logic: If they fall "out" of the hourglass shape, we could kill them, 
                // but just letting them fall 'behind' the mask is cleaner.
            }

            update() {
                this.vy += this.gravity;
                this.x += this.vx;
                this.y += this.vy;

                // Stop at bottom of hourglass
                if (this.y > this.floor) {
                    this.y = this.floor;
                    this.vy *= -0.3; // Dampened bounce
                    this.vx *= 0.8;
                }
                
                this.life--;
            }

            draw() {
                ctx.fillStyle = this.color;
                ctx.beginPath();
                // Diamond shape for "gem" look
                ctx.moveTo(this.x, this.y - this.size);
                ctx.lineTo(this.x + this.size, this.y);
                ctx.lineTo(this.x, this.y + this.size);
                ctx.lineTo(this.x - this.size, this.y);
                ctx.fill();
            }
        }

        function triggerParticles(house, amount) {
            // Cap particles to avoid lag if someone gives 1000 points
            let count = Math.min(amount, 20); 
            if (count < 5) count = 5; // Minimum burst

            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    particles.push(new Particle(house));
                }, i * 50); // Stagger them
            }
        }

        function animateParticles() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            for (let i = 0; i < particles.length; i++) {
                particles[i].update();
                particles[i].draw();
            }

            // Remove dead particles
            particles = particles.filter(p => p.life > 0);
            
            requestAnimationFrame(animateParticles);
        }
        animateParticles();

    </script>
</body>
</html>
