<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hogwarts House Points 1.0 (Fixed Layers)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/comfy.js@latest/dist/comfy.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap');

        body {
            font-family: 'Cinzel', serif;
            background-color: #0f0f13;
            background-image: radial-gradient(circle at 50% 50%, #1a1a24 0%, #0a0a0c 100%);
            color: #e2e8f0;
            overflow: hidden;
        }

        /* Colors */
        .gryffindor-color { color: #ff4d4d; }
        .slytherin-color { color: #2ecc71; }
        .ravenclaw-color { color: #3498db; }
        .hufflepuff-color { color: #f1c40f; }
        
        .magic-input {
            background: rgba(0, 0, 0, 0.5); border: 1px solid #4a5568; color: #e2e8f0; transition: all 0.3s ease;
        }
        .magic-input:focus { border-color: #f6ad55; outline: none; }

        /* --- THE HOURGLASS STACKING --- */
        .hourglass-wrapper {
            position: relative;
            width: 120px;
            height: 360px; /* Fixed height for consistency */
            margin: 0 auto;
        }

        /* 1. BOTTOM LAYER: Falling Particles */
        .sand-canvas {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 0; 
            pointer-events: none;
        }

        /* 2. MIDDLE LAYER: Rising Sand Pile */
        .fill-container {
            position: absolute;
            bottom: 30px; /* Align with bottom bulb curvature */
            left: 10px; right: 10px; /* Narrower than frame */
            height: 140px; /* Max fill height of bottom bulb */
            z-index: 10;
            overflow: hidden;
            border-bottom-left-radius: 50px;
            border-bottom-right-radius: 50px;
        }
        .fill-level {
            width: 100%;
            height: 100%;
            transform-origin: bottom;
            transform: scaleY(0); /* Starts empty */
            transition: transform 1s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* 3. TOP LAYER: Glass Frame & Shine */
        .glass-frame {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 20;
            pointer-events: none;
        }
        
        /* Debug Button */
        .test-btn {
            opacity: 0; transform: translateY(10px); transition: all 0.3s ease;
        }
        .house-container:hover .test-btn { opacity: 1; transform: translateY(0); }
    </style>
</head>
<body class="h-screen w-full flex flex-col items-center justify-between py-6">

    <!-- Header -->
    <div class="z-50 w-full max-w-4xl px-4 flex flex-col md:flex-row items-center justify-between gap-4 mb-4">
        <h1 class="text-3xl font-bold tracking-widest text-amber-500 drop-shadow-lg">HOUSE POINTS</h1>
        <div class="flex gap-2 relative">
            <input type="text" id="channelInput" placeholder="Twitch Channel" class="magic-input px-4 py-2 rounded font-sans text-sm w-48">
            <button onclick="connectToTwitch()" id="connectBtn" class="bg-amber-700 hover:bg-amber-600 text-white font-bold py-2 px-6 rounded text-sm font-sans border border-amber-800">CONNECT</button>
        </div>
        <div id="status" class="text-xs text-gray-500 font-sans italic">Status: Disconnected</div>
    </div>

    <!-- Main Grid -->
    <div class="flex-grow w-full max-w-6xl grid grid-cols-4 gap-4 px-4 items-end justify-items-center">

        <!-- GRYFFINDOR -->
        <div class="house-container flex flex-col items-center w-full h-full justify-end" data-house="gryffindor">
            <button onclick="manualAdd('gryffindor')" class="test-btn mb-4 px-3 py-1 bg-gray-800 text-xs rounded text-gray-400">Test +10</button>
            <div class="text-4xl font-bold mb-2 gryffindor-color score-display">0</div>
            
            <div class="hourglass-wrapper">
                <!-- Layer 1: Particles -->
                <canvas class="sand-canvas" id="canvas-gryffindor"></canvas>
                
                <!-- Layer 2: Fill -->
                <div class="fill-container">
                    <div class="fill-level bg-[#740001]"></div>
                </div>

                <!-- Layer 3: Frame -->
                <svg viewBox="0 0 100 300" class="glass-frame drop-shadow-2xl">
                    <!-- Glass Tint -->
                    <path d="M10,0 L90,0 Q100,50 50,150 Q0,250 10,300 L90,300 Q100,250 50,150 Q0,50 10,0 Z" 
                          fill="rgba(255,255,255,0.05)" stroke="#4a1a1a" stroke-width="4"/>
                    <!-- Glare -->
                    <path d="M20,10 Q50,60 25,140" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="3" stroke-linecap="round"/>
                    <path d="M25,160 Q60,250 20,290" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="3" stroke-linecap="round"/>
                </svg>
            </div>
            <h2 class="mt-4 text-xl font-bold tracking-widest text-gray-400">Griffendél</h2>
        </div>

        <!-- SLYTHERIN -->
        <div class="house-container flex flex-col items-center w-full h-full justify-end" data-house="slytherin">
            <button onclick="manualAdd('slytherin')" class="test-btn mb-4 px-3 py-1 bg-gray-800 text-xs rounded text-gray-400">Test +10</button>
            <div class="text-4xl font-bold mb-2 slytherin-color score-display">0</div>
            
            <div class="hourglass-wrapper">
                <canvas class="sand-canvas" id="canvas-slytherin"></canvas>
                <div class="fill-container">
                    <div class="fill-level bg-[#1a472a]"></div>
                </div>
                <svg viewBox="0 0 100 300" class="glass-frame drop-shadow-2xl">
                    <path d="M10,0 L90,0 Q100,50 50,150 Q0,250 10,300 L90,300 Q100,250 50,150 Q0,50 10,0 Z" 
                          fill="rgba(255,255,255,0.05)" stroke="#1a472a" stroke-width="4"/>
                    <path d="M20,10 Q50,60 25,140" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="3" stroke-linecap="round"/>
                    <path d="M25,160 Q60,250 20,290" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="3" stroke-linecap="round"/>
                </svg>
            </div>
            <h2 class="mt-4 text-xl font-bold tracking-widest text-gray-400">Mardekár</h2>
        </div>

        <!-- RAVENCLAW -->
        <div class="house-container flex flex-col items-center w-full h-full justify-end" data-house="ravenclaw">
            <button onclick="manualAdd('ravenclaw')" class="test-btn mb-4 px-3 py-1 bg-gray-800 text-xs rounded text-gray-400">Test +10</button>
            <div class="text-4xl font-bold mb-2 ravenclaw-color score-display">0</div>
            
            <div class="hourglass-wrapper">
                <canvas class="sand-canvas" id="canvas-ravenclaw"></canvas>
                <div class="fill-container">
                    <div class="fill-level bg-[#222f5b]"></div>
                </div>
                <svg viewBox="0 0 100 300" class="glass-frame drop-shadow-2xl">
                    <path d="M10,0 L90,0 Q100,50 50,150 Q0,250 10,300 L90,300 Q100,250 50,150 Q0,50 10,0 Z" 
                          fill="rgba(255,255,255,0.05)" stroke="#0e1a40" stroke-width="4"/>
                    <path d="M20,10 Q50,60 25,140" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="3" stroke-linecap="round"/>
                    <path d="M25,160 Q60,250 20,290" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="3" stroke-linecap="round"/>
                </svg>
            </div>
            <h2 class="mt-4 text-xl font-bold tracking-widest text-gray-400">Hollóhát</h2>
        </div>

        <!-- HUFFLEPUFF -->
        <div class="house-container flex flex-col items-center w-full h-full justify-end" data-house="hufflepuff">
            <button onclick="manualAdd('hufflepuff')" class="test-btn mb-4 px-3 py-1 bg-gray-800 text-xs rounded text-gray-400">Test +10</button>
            <div class="text-4xl font-bold mb-2 hufflepuff-color score-display">0</div>
            
            <div class="hourglass-wrapper">
                <canvas class="sand-canvas" id="canvas-hufflepuff"></canvas>
                <div class="fill-container">
                    <div class="fill-level bg-[#ecb939]"></div>
                </div>
                <svg viewBox="0 0 100 300" class="glass-frame drop-shadow-2xl">
                    <path d="M10,0 L90,0 Q100,50 50,150 Q0,250 10,300 L90,300 Q100,250 50,150 Q0,50 10,0 Z" 
                          fill="rgba(255,255,255,0.05)" stroke="#ecb939" stroke-width="4"/>
                    <path d="M20,10 Q50,60 25,140" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="3" stroke-linecap="round"/>
                    <path d="M25,160 Q60,250 20,290" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="3" stroke-linecap="round"/>
                </svg>
            </div>
            <h2 class="mt-4 text-xl font-bold tracking-widest text-gray-400">Hugrabug</h2>
        </div>
    </div>

    <!-- Log -->
    <div id="log" class="text-[10px] text-gray-700 font-sans fixed bottom-2 right-2 opacity-50">Waiting...</div>

    <script>
        // --- CONFIG ---
        const HOUSE_CONFIG = {
            gryffindor: { color: '#740001', maxPoints: 500, current: 0 },
            slytherin:  { color: '#1a472a', maxPoints: 500, current: 0 },
            ravenclaw:  { color: '#222f5b', maxPoints: 500, current: 0 },
            hufflepuff: { color: '#ecb939', maxPoints: 500, current: 0 }
        };

        const HOUSE_MAPPING = {
            'gryffindor': 'gryffindor', 'griffendél': 'gryffindor',
            'slytherin': 'slytherin', 'mardekár': 'slytherin',
            'ravenclaw': 'ravenclaw', 'hollóhát': 'ravenclaw',
            'hufflepuff': 'hufflepuff', 'hugrabug': 'hufflepuff'
        };

        // --- CANVAS SETUP ---
        // We now have 4 separate canvases, one for each house
        const canvases = {};
        const contexts = {};
        
        function initCanvases() {
            ['gryffindor', 'slytherin', 'ravenclaw', 'hufflepuff'].forEach(house => {
                const cvs = document.getElementById(`canvas-${house}`);
                // Match the visual size of the wrapper
                cvs.width = 120; 
                cvs.height = 360;
                canvases[house] = cvs;
                contexts[house] = cvs.getContext('2d');
            });
        }
        window.addEventListener('load', initCanvases);

        // --- LOGIC ---
        function updatePoints(house, points) {
            const config = HOUSE_CONFIG[house];
            config.current += points;
            if (config.current < 0) config.current = 0;

            const container = document.querySelector(`.house-container[data-house="${house}"]`);
            container.querySelector('.score-display').textContent = config.current;
            
            // FILL LOGIC: Simple scaleY on the inner div
            const percentage = Math.min(config.current / config.maxPoints, 1);
            container.querySelector('.fill-level').style.transform = `scaleY(${percentage})`;
        }

        function manualAdd(house) {
            updatePoints(house, 10);
            triggerParticles(house, 10);
        }

        // --- PARTICLE SYSTEM ---
        let particles = [];

        class Particle {
            constructor(house) {
                this.house = house;
                // Spawn relative to local canvas (120x360)
                // Top bulb area is roughly y=0 to y=140
                this.x = 60 + (Math.random() * 60 - 30); // Center x=60, width +/- 30
                this.y = 20; 
                
                this.vx = (Math.random() - 0.5) * 1.5;
                this.vy = Math.random() * 3 + 2;
                this.gravity = 0.15;
                this.size = Math.random() * 2.5 + 1.5;
                this.color = HOUSE_CONFIG[house].color;
                this.life = 100;
            }
            update() {
                this.vy += this.gravity;
                this.x += this.vx;
                this.y += this.vy;
                
                // Narrowing at neck (approx y=150)
                if (this.y > 130 && this.y < 170) {
                    // Force towards center
                    if (this.x < 55) this.vx += 0.2;
                    if (this.x > 65) this.vx -= 0.2;
                }

                // Hit bottom pile (approx y=330)
                if (this.y > 330) {
                    this.y = 330;
                    this.vy *= -0.4;
                    this.vx *= 0.6;
                }
                this.life--;
            }
            draw(ctx) {
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.rect(this.x, this.y, this.size, this.size); // Simple square sand
                ctx.fill();
            }
        }

        function triggerParticles(house, amount) {
            let count = Math.min(amount, 20);
            if (count < 5) count = 5;
            for (let i = 0; i < count; i++) {
                setTimeout(() => particles.push(new Particle(house)), i * 30);
            }
        }

        function animateLoop() {
            // Clear all 4 canvases
            Object.values(contexts).forEach(ctx => ctx.clearRect(0, 0, 120, 360));

            for (let i = 0; i < particles.length; i++) {
                let p = particles[i];
                p.update();
                // Draw on the specific house canvas
                if (contexts[p.house]) p.draw(contexts[p.house]);
            }
            particles = particles.filter(p => p.life > 0);
            requestAnimationFrame(animateLoop);
        }
        animateLoop();

        // --- TWITCH ---
        function connectToTwitch() {
            let channel = document.getElementById('channelInput').value.trim();
            if (!channel) return alert("Enter channel!");
            
            // Clean input
            channel = channel.replace(/^(?:https?:\/\/)?(?:www\.)?twitch\.tv\//, '').replace(/^#/, '').replace(/\/.*$/, '').toLowerCase();
            
            document.getElementById('status').textContent = `Connecting to ${channel}...`;
            
            ComfyJS.onChat = (user, message, flags, self, extra) => {
                const regex = /(-?\d+)\s+(?:points?|pont[a-z]*)\s+(?:to|for|a)?\s*(gryffindor|slytherin|ravenclaw|hufflepuff|griffendél|mardekár|hollóhát|hugrabug)/i;
                const match = message.match(regex);
                if (match) {
                    const pts = parseInt(match[1]);
                    const house = HOUSE_MAPPING[match[2].toLowerCase()];
                    if (house) {
                        updatePoints(house, pts);
                        if (pts > 0) triggerParticles(house, pts);
                        // Log
                        const log = document.getElementById('log');
                        log.textContent = `${user}: ${pts} to ${house}`;
                        log.style.opacity = 1; setTimeout(() => log.style.opacity = 0.5, 2000);
                    }
                }
            };

            ComfyJS.onConnected = () => {
                const s = document.getElementById('status');
                s.textContent = "Connected!";
                s.className = "text-xs text-green-500 font-sans italic";
                document.getElementById('connectBtn').textContent = "CONNECTED";
                document.getElementById('connectBtn').classList.add('bg-green-700');
            };

            ComfyJS.Init(channel);
        }
    </script>
</body>
</html>
